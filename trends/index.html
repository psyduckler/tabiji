<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Destination Trends ‚Äî tabiji.ai</title>
<style>
  :root { --bg: #0a0a0f; --card: #14141f; --border: #1e1e2e; --text: #e0e0e8; --muted: #7a7a8e; --green: #22c55e; --red: #ef4444; --accent: #8b5cf6; --hover: #1a1a2a; }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 2rem; max-width: 1200px; margin: 0 auto; }
  h1 { font-size: 1.8rem; font-weight: 600; margin-bottom: 0.3rem; }
  .subtitle { color: var(--muted); margin-bottom: 1.5rem; font-size: 0.9rem; }
  a { color: var(--accent); text-decoration: none; }

  /* Filters */
  .filters { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap; align-items: center; }
  .filter-group { display: flex; gap: 0.25rem; background: var(--card); border-radius: 8px; padding: 3px; border: 1px solid var(--border); }
  .filter-btn { padding: 6px 14px; border-radius: 6px; border: none; background: transparent; color: var(--muted); cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.15s; }
  .filter-btn:hover { color: var(--text); }
  .filter-btn.active { background: var(--accent); color: #fff; }
  .search-box { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 8px 14px; color: var(--text); font-size: 0.85rem; width: 200px; outline: none; }
  .search-box:focus { border-color: var(--accent); }
  .search-box::placeholder { color: var(--muted); }

  /* Table */
  table { width: 100%; border-collapse: collapse; }
  thead th { text-align: left; padding: 12px 16px; color: var(--muted); font-weight: 500; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); cursor: pointer; user-select: none; white-space: nowrap; }
  thead th:hover { color: var(--text); }
  thead th .sort-arrow { margin-left: 4px; font-size: 0.7rem; }
  tbody tr { border-bottom: 1px solid var(--border); transition: background 0.1s; }
  tbody tr:hover { background: var(--hover); }
  td { padding: 14px 16px; font-size: 0.95rem; }
  td.rank { color: var(--muted); font-size: 0.85rem; width: 40px; }
  td.name { font-weight: 600; }
  td.num { text-align: right; font-variant-numeric: tabular-nums; }
  .velocity-badge { font-weight: 700; font-size: 0.9rem; padding: 3px 10px; border-radius: 6px; display: inline-block; }
  .velocity-badge.up { color: var(--green); background: rgba(34,197,94,0.1); }
  .velocity-badge.down { color: var(--red); background: rgba(239,68,68,0.1); }
  .velocity-badge.flat { color: var(--muted); background: rgba(122,122,142,0.1); }
  .sparkline { width: 120px; height: 32px; }
  .trend-label { font-size: 0.8rem; font-weight: 500; padding: 3px 8px; border-radius: 4px; }
  .trend-label.rising { color: var(--green); background: rgba(34,197,94,0.08); }
  .trend-label.falling { color: var(--red); background: rgba(239,68,68,0.08); }
  .trend-label.steady { color: var(--muted); background: rgba(122,122,142,0.08); }

  #loading { text-align: center; color: var(--muted); padding: 4rem; }
  .no-results { text-align: center; color: var(--muted); padding: 3rem; font-size: 0.95rem; }

  /* Modal */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.6); z-index: 100; align-items: center; justify-content: center; padding: 20px; }
  .modal-overlay.show { display: flex; }
  .modal { background: var(--card); border: 1px solid var(--border); border-radius: 16px; max-width: 560px; width: 100%; max-height: 90vh; overflow-y: auto; position: relative; padding: 28px; }
  .modal-close { position: absolute; top: 12px; right: 12px; width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,.08); border: none; color: var(--muted); font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
  .modal-close:hover { color: var(--text); background: rgba(255,255,255,.15); }
  .modal h2 { font-size: 1.4rem; margin-bottom: 4px; }
  .modal .modal-trend { margin-bottom: 20px; }
  .modal .modal-chart { margin: 16px 0; }
  .modal .modal-chart svg { width: 100%; height: 120px; }
  .modal .modal-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 20px 0; }
  .modal .stat-box { background: rgba(255,255,255,.04); border-radius: 10px; padding: 14px; text-align: center; }
  .modal .stat-box .stat-label { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px; }
  .modal .stat-box .stat-value { font-size: 1.3rem; font-weight: 700; font-variant-numeric: tabular-nums; }
  .modal .modal-dates { font-size: 0.8rem; color: var(--muted); display: flex; justify-content: space-between; margin-top: -8px; margin-bottom: 12px; }
  .modal .modal-cta { display: block; text-align: center; background: var(--accent); color: #fff; padding: 12px; border-radius: 10px; font-weight: 600; font-size: 0.95rem; margin-top: 20px; transition: opacity 0.15s; }
  .modal .modal-cta:hover { opacity: 0.85; }
  tbody tr { cursor: pointer; }

  @media (max-width: 768px) {
    body { padding: 1rem; }
    .filters { gap: 0.5rem; }
    .search-box { width: 100%; }
    td, th { padding: 10px 8px; }
    .sparkline { width: 80px; }
    .hide-mobile { display: none; }
  }
</style>
</head>
<body>
<h1>üìä Destination Trends</h1>
<p class="subtitle">Search interest over the last 12 months ¬∑ <a href="https://tabiji.ai">tabiji.ai</a> ¬∑ Updated <span id="updated"></span></p>

<div class="filters">
  <input type="text" class="search-box" id="search" placeholder="Search destinations‚Ä¶">
  <div class="filter-group" id="trend-filter">
    <button class="filter-btn active" data-filter="all">All</button>
    <button class="filter-btn" data-filter="rising">üî• Rising</button>
    <button class="filter-btn" data-filter="falling">üìâ Falling</button>
    <button class="filter-btn" data-filter="steady">‚û°Ô∏è Steady</button>
  </div>
</div>

<div id="loading">Loading trends data‚Ä¶</div>
<table id="table" style="display:none">
  <thead>
    <tr>
      <th data-sort="rank"># <span class="sort-arrow"></span></th>
      <th data-sort="name">Destination <span class="sort-arrow"></span></th>
      <th data-sort="current" style="text-align:right">Current <span class="sort-arrow"></span></th>
      <th data-sort="peak" style="text-align:right" class="hide-mobile">Peak <span class="sort-arrow"></span></th>
      <th data-sort="velocity" style="text-align:right">1Y Change <span class="sort-arrow"></span></th>
      <th>Trend</th>
      <th class="hide-mobile">Last 12 Months</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>
<div id="no-results" class="no-results" style="display:none">No destinations match your filters.</div>

<!-- Modal -->
<div class="modal-overlay" id="modal" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <h2 id="mName"></h2>
    <div class="modal-trend" id="mTrend"></div>
    <div class="modal-chart" id="mChart"></div>
    <div class="modal-dates"><span id="mDateStart"></span><span id="mDateEnd"></span></div>
    <div class="modal-stats">
      <div class="stat-box"><div class="stat-label">Current</div><div class="stat-value" id="mCurrent"></div></div>
      <div class="stat-box"><div class="stat-label">Peak</div><div class="stat-value" id="mPeak"></div></div>
      <div class="stat-box"><div class="stat-label">1Y Change</div><div class="stat-value" id="mChange"></div></div>
    </div>
    <a class="modal-cta" id="mCta" href="#">Plan this trip ‚Üí</a>
  </div>
</div>

<script>
let allDests = [];
let sortCol = 'velocity';
let sortDir = -1; // descending

function sparkline(values, color) {
  const w = 120, h = 28;
  const max = Math.max(...values, 1), min = Math.min(...values, 0);
  const range = max - min || 1;
  const pts = values.map((v, i) => `${(i / (values.length - 1)) * w},${h - ((v - min) / range) * (h - 4) - 2}`).join(' ');
  return `<svg class="sparkline" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none"><polyline points="${pts}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
}

function calcVelocity(values) {
  if (values.length < 8) return 0;
  const recent = values.slice(-4).reduce((a, b) => a + b, 0) / 4;
  const earliest = values.slice(0, 4).reduce((a, b) => a + b, 0) / 4;
  if (earliest === 0) return recent > 0 ? 100 : 0;
  return ((recent - earliest) / earliest) * 100;
}

function trendClass(v) { return v > 5 ? 'rising' : v < -5 ? 'falling' : 'steady'; }

function render() {
  const search = document.getElementById('search').value.toLowerCase();
  const filter = document.querySelector('#trend-filter .filter-btn.active').dataset.filter;

  let filtered = allDests.filter(d => {
    if (search && !d.destination.toLowerCase().includes(search)) return false;
    if (filter !== 'all' && d.trend !== filter) return false;
    return true;
  });

  // Sort
  filtered.sort((a, b) => {
    let va, vb;
    if (sortCol === 'name') { va = a.destination; vb = b.destination; return sortDir * va.localeCompare(vb); }
    if (sortCol === 'rank') { va = a.rank; vb = b.rank; }
    else if (sortCol === 'current') { va = a.current; vb = b.current; }
    else if (sortCol === 'peak') { va = a.peak; vb = b.peak; }
    else if (sortCol === 'velocity') { va = a.velocity; vb = b.velocity; }
    return sortDir * ((va || 0) - (vb || 0));
  });

  const tbody = document.getElementById('tbody');
  if (filtered.length === 0) {
    tbody.innerHTML = '';
    document.getElementById('no-results').style.display = 'block';
    return;
  }
  document.getElementById('no-results').style.display = 'none';

  tbody.innerHTML = filtered.map((d, i) => {
    const vClass = d.velocity > 5 ? 'up' : d.velocity < -5 ? 'down' : 'flat';
    const vSign = d.velocity > 0 ? '+' : '';
    const color = d.velocity > 5 ? '#22c55e' : d.velocity < -5 ? '#ef4444' : '#7a7a8e';
    return `<tr onclick="openModal('${d.destination.replace(/'/g,"\\'")}')">
      <td class="rank">${d.rank}</td>
      <td class="name">${d.destination}</td>
      <td class="num">${d.current}</td>
      <td class="num hide-mobile">${d.peak}</td>
      <td class="num"><span class="velocity-badge ${vClass}">${vSign}${d.velocity.toFixed(1)}%</span></td>
      <td><span class="trend-label ${d.trend}">${d.trend === 'rising' ? 'üî• Rising' : d.trend === 'falling' ? 'üìâ Falling' : '‚û°Ô∏è Steady'}</span></td>
      <td class="hide-mobile">${sparkline(d.values, color)}</td>
    </tr>`;
  }).join('');
}

// Sort headers
document.querySelectorAll('thead th[data-sort]').forEach(th => {
  th.addEventListener('click', () => {
    const col = th.dataset.sort;
    if (sortCol === col) sortDir *= -1;
    else { sortCol = col; sortDir = col === 'name' ? 1 : -1; }
    // Update arrows
    document.querySelectorAll('thead th .sort-arrow').forEach(s => s.textContent = '');
    th.querySelector('.sort-arrow').textContent = sortDir === 1 ? '‚ñ≤' : '‚ñº';
    render();
  });
});

// Filters
document.querySelectorAll('#trend-filter .filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('#trend-filter .filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    render();
  });
});

document.getElementById('search').addEventListener('input', render);

// Modal
function bigSparkline(values, color) {
  const w = 500, h = 110;
  const max = Math.max(...values, 1), min = Math.min(...values, 0);
  const range = max - min || 1;
  const pts = values.map((v, i) => `${(i / (values.length - 1)) * w},${h - ((v - min) / range) * (h - 8) - 4}`).join(' ');
  const fillPts = pts + ` ${w},${h} 0,${h}`;
  const gradId = 'g' + Math.random().toString(36).slice(2,8);
  return `<svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none">
    <defs><linearGradient id="${gradId}" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${color}" stop-opacity="0.2"/><stop offset="100%" stop-color="${color}" stop-opacity="0"/></linearGradient></defs>
    <polygon points="${fillPts}" fill="url(#${gradId})"/>
    <polyline points="${pts}" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>`;
}

function openModal(destName) {
  const d = allDests.find(x => x.destination === destName);
  if (!d) return;
  const color = d.velocity > 5 ? '#22c55e' : d.velocity < -5 ? '#ef4444' : '#8b5cf6';
  const vSign = d.velocity > 0 ? '+' : '';
  const vClass = d.velocity > 5 ? 'up' : d.velocity < -5 ? 'down' : 'flat';
  document.getElementById('mName').textContent = d.destination;
  document.getElementById('mTrend').innerHTML = `<span class="velocity-badge ${vClass}">${vSign}${d.velocity.toFixed(1)}%</span> <span class="trend-label ${d.trend}">${d.trend === 'rising' ? 'üî• Rising' : d.trend === 'falling' ? 'üìâ Falling' : '‚û°Ô∏è Steady'}</span>`;
  document.getElementById('mChart').innerHTML = bigSparkline(d.values, color);
  document.getElementById('mCurrent').textContent = d.current;
  document.getElementById('mPeak').textContent = d.peak;
  document.getElementById('mChange').innerHTML = `<span style="color:${d.velocity > 5 ? 'var(--green)' : d.velocity < -5 ? 'var(--red)' : 'var(--muted)'}">${vSign}${d.velocity.toFixed(1)}%</span>`;
  document.getElementById('mDateStart').textContent = d.dates[0] || '';
  document.getElementById('mDateEnd').textContent = d.dates[d.dates.length - 1] || '';
  document.getElementById('mCta').href = `/plan.html?destination=${encodeURIComponent(d.rawName)}`;
  document.getElementById('modal').classList.add('show');
  document.body.style.overflow = 'hidden';
}

function closeModal() {
  document.getElementById('modal').classList.remove('show');
  document.body.style.overflow = '';
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

// Load data
fetch('trends-data.json')
  .then(r => r.json())
  .then(data => {
    document.getElementById('updated').textContent = new Date(data.updated).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

    allDests = data.destinations.map((d, i) => {
      const velocity = calcVelocity(d.values);
      return {
        rank: i + 1,
        destination: d.country && d.country !== d.destination ? `${d.destination}, ${d.country}` : d.destination,
        rawName: d.destination,
        values: d.values,
        dates: d.dates || [],
        current: d.values[d.values.length - 1] || 0,
        peak: Math.max(...d.values),
        velocity,
        trend: trendClass(velocity),
      };
    });

    // Default sort by velocity desc
    allDests.sort((a, b) => b.velocity - a.velocity);
    allDests.forEach((d, i) => d.rank = i + 1);

    document.getElementById('loading').style.display = 'none';
    document.getElementById('table').style.display = 'table';
    // Set initial sort arrow
    document.querySelector('th[data-sort="velocity"] .sort-arrow').textContent = '‚ñº';
    render();
  });
</script>
</body>
</html>
